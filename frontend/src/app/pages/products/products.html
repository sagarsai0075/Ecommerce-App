<div class="page-layout">

  <input id="filters-toggle" class="filters-toggle" type="checkbox" aria-controls="filters-panel" />
  <label class="filters-toggle-btn" for="filters-toggle">
    Filters
    <span class="filters-toggle-icon" aria-hidden="true">▾</span>
  </label>

  <!-- LEFT FILTER -->
  <aside id="filters-panel" class="filter-panel" aria-label="Product filters">

    <div class="filter-header">
      <h3>Filters</h3>
      <button type="button" class="clear-filters" title="Clear all filters" aria-label="Clear all filters" (click)="clearFilters()">Clear</button>
    </div>

    <form class="filters" (submit)="$event.preventDefault()">

      <!-- SORT -->
      <div class="filter-block">
        <h4>Sort By</h4>

        <label for="sort-newest">
          <input id="sort-newest" type="radio" name="sort" value="newest" (change)="onSortChange($event)" [checked]="filters.sort === 'newest'" />
          Newest First
        </label>

        <label for="sort-low">
          <input id="sort-low" type="radio" name="sort" value="low" (change)="onSortChange($event)" [checked]="filters.sort === 'low'" />
          Price: Low to High
        </label>

        <label for="sort-high">
          <input id="sort-high" type="radio" name="sort" value="high" (change)="onSortChange($event)" [checked]="filters.sort === 'high'" />
          Price: High to Low
        </label>
      </div>

      <hr />

      <!-- PRICE RANGE -->
      <div class="filter-block">
        <h4>Price Range</h4>
        <label *ngFor="let range of availablePriceRanges" [attr.for]="'price-' + range.id">
          <input
            [id]="'price-' + range.id"
            type="checkbox"
            name="price"
            [value]="range.id"
            [checked]="filters.priceRanges.includes(range.id)"
            (change)="onPriceRangeChange($event, range.id)"
          />
          {{ range.label }}
        </label>
      </div>

      <hr />

      <!-- BRAND -->
      <div class="filter-block">
        <h4>Brand</h4>
        <label *ngFor="let brand of availableBrands" [attr.for]="'brand-' + brand">
          <input
            [id]="'brand-' + brand"
            type="checkbox"
            name="brand"
            [value]="brand"
            [checked]="filters.brands.includes(brand)"
            (change)="onBrandChange($event, brand)"
          />
          {{ brand }}
        </label>
      </div>

      <hr />

      <!-- CUSTOMER RATING -->
      <div class="filter-block">
        <h4>Customer Ratings</h4>
        <label *ngFor="let rating of availableRatings" class="rating-filter" [attr.for]="'rating-' + rating">
          <input
            [id]="'rating-' + rating"
            type="checkbox"
            name="rating"
            [value]="rating"
            [checked]="filters.ratings.includes(rating)"
            (change)="onRatingChange($event, rating)"
          />
          <span class="rating-badge">{{ rating }}</span>
          <span class="stars" [style.--rating]="rating" aria-hidden="true"></span>
          <span class="rating-text">&amp; above</span>
        </label>
      </div>

    </form>
  </aside>


  <!-- RIGHT CONTENT -->
  <section class="content" aria-live="polite">

    <!-- header removed to align products with filters -->

    <div class="compare-bar" *ngIf="compareList.length">
      <div class="compare-count">Compare ({{ compareList.length }}/2)</div>

      <div class="compare-items">
        <div class="compare-chip" *ngFor="let c of compareList">
          <span>{{ c.name }}</span>
          <button type="button" (click)="removeCompare(c)" aria-label="Remove {{ c.name }}">
            ×
          </button>
        </div>
      </div>

      <div class="compare-actions">
        <span class="compare-hint" *ngIf="compareList.length < 2">Select 1 more to compare</span>
        <button type="button" class="compare-clear" (click)="clearCompare()">Clear</button>
      </div>

      <div class="compare-error" *ngIf="compareError">{{ compareError }}</div>
    </div>

    <section id="compare-panel" class="compare-panel" *ngIf="compareList.length === 2">
      <div class="compare-title">Product Comparison</div>

      <div class="compare-hero">
        <div class="compare-label">Product</div>
        <div class="compare-hero-card">
          <img [src]="compareList[0].image" [alt]="compareList[0].name" />
          <div class="compare-hero-name">{{ compareList[0].name }}</div>
        </div>
        <div class="compare-hero-card">
          <img [src]="compareList[1].image" [alt]="compareList[1].name" />
          <div class="compare-hero-name">{{ compareList[1].name }}</div>
        </div>
      </div>

      <div class="compare-table">
        <div class="compare-row">
          <div class="compare-label">Price</div>
          <div class="compare-value">₹{{ getFinalPrice(compareList[0]) }}</div>
          <div class="compare-value">₹{{ getFinalPrice(compareList[1]) }}</div>
        </div>

        <div class="compare-row">
          <div class="compare-label">Brand</div>
          <div class="compare-value">{{ compareList[0].brand || '—' }}</div>
          <div class="compare-value">{{ compareList[1].brand || '—' }}</div>
        </div>

        <div class="compare-row">
          <div class="compare-label">Rating</div>
          <div class="compare-value">{{ compareList[0].rating || '—' }}</div>
          <div class="compare-value">{{ compareList[1].rating || '—' }}</div>
        </div>

        <div class="compare-row">
          <div class="compare-label">Discount</div>
          <div class="compare-value">{{ compareList[0].discount ? (compareList[0].discount + '%') : '—' }}</div>
          <div class="compare-value">{{ compareList[1].discount ? (compareList[1].discount + '%') : '—' }}</div>
        </div>

        <div class="compare-row">
          <div class="compare-label">Specifications</div>
          <div class="compare-value">{{ formatSpecs(compareList[0]) }}</div>
          <div class="compare-value">{{ formatSpecs(compareList[1]) }}</div>
        </div>
      </div>
    </section>

    <div class="products-list">
      <div class="product-card" *ngFor="let p of displayedProducts; let i = index; trackBy: trackByProduct" role="article" [attr.aria-labelledby]="'product-title-' + i">

        <!-- IMAGE -->
        <div class="img-box">
          <img [src]="p.image" [alt]="p.name || 'Product image'" />
        </div>

        <!-- DETAILS -->
        <div class="info-box">

          <div class="top-row">
            <span class="sponsored" *ngIf="p.sponsored">Sponsored</span>
          </div>

          <h3 id="product-title-{{ i }}">{{ p.name }}</h3>

          <div class="rating" aria-label="Rated {{ p.rating || '4.3' }} out of 5">
            <span class="rating-badge">{{ p.rating || '4.3' }}</span>
            <span class="stars" [style.--rating]="p.rating || 4.3" aria-hidden="true"></span>
            <span class="reviews">{{ p.reviewsCount || '89' }} Ratings</span>
          </div>

          <ul class="specifications-list" *ngIf="p.specifications">
            <li *ngFor="let spec of p.specifications">{{ spec }}</li>
          </ul>

          <ul>
            <li *ngFor="let feat of (p.features || ['Warranty included'])">{{ feat }}</li>
          </ul>

          <label class="compare" [attr.for]="'compare-' + i">
            <input
              id="compare-{{ i }}"
              type="checkbox"
              [checked]="isCompared(p)"
              [disabled]="compareList.length >= 2 && !isCompared(p)"
              (change)="toggleCompare(p, $event)"
            />
            <span>Add to Compare</span>
          </label>

        </div>

        <!-- PRICE -->
        <div class="price-box">

          <div class="price">₹{{ getFinalPrice(p) }}</div>

          <div class="old" *ngIf="p.discount">
            ₹{{ p.price }}
          </div>

          <div class="off" *ngIf="p.discount">
            {{ p.discount }}% off
          </div>

          <button type="button" (click)="addToCart(p)" aria-label="Add {{ p.name }} to cart">Add to Cart</button>

        </div>

      </div>
    </div>

  </section>

</div>
